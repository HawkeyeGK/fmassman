@page "/"
@using FM26_Helper.Shared
@using FM26_Helper.Web.Models
@inject RosterRepository Repository
@inject IConfiguration Configuration

<PageTitle>Player Roster</PageTitle>

<h1>Player Roster</h1>

@if (rosterItems == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>Name</th>
                <th>Age</th>
                <th>Wage</th>
                <th>Contract</th>
                <th>Speed</th>
                <th>DNA</th>
                <th>Gegenpress</th>
                <th>Best Role (In)</th>
                <th>Best Role (Out)</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in rosterItems)
            {
                <tr>
                    <td>@item.Name</td>
                    <td>@item.Age</td>
                    <td>@item.Wage</td>
                    <td>@item.ContractExpiry</td>
                    <td>@item.Speed.ToString("F1")</td>
                    <td>@item.DNA.ToString("F1")</td>
                    <td>@item.Gegenpress.ToString("F1")</td>
                    <td>@item.BestInPossessionRole (@item.BestInPossessionScore.ToString("F1")%)</td>
                    <td>@item.BestOutPossessionRole (@item.BestOutPossessionScore.ToString("F1")%)</td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private List<RosterItemViewModel>? rosterItems;

    protected override void OnInitialized()
    {
        var path = Configuration["RosterFilePath"];
        if (!string.IsNullOrEmpty(path))
        {
            var players = Repository.Load(path);
            rosterItems = new List<RosterItemViewModel>();

            foreach (var player in players)
            {
                var analysis = PlayerAnalyzer.Analyze(player.Snapshot);
                var bestIn = analysis.InPossessionFits.OrderByDescending(r => r.Score).FirstOrDefault();
                var bestOut = analysis.OutPossessionFits.OrderByDescending(r => r.Score).FirstOrDefault();

                rosterItems.Add(new RosterItemViewModel
                {
                    Name = player.PlayerName,
                    Age = player.Snapshot?.Age ?? 0,
                    Wage = player.Snapshot?.Wage ?? "",
                    ContractExpiry = player.Snapshot?.ContractExpiry ?? "",
                    Speed = analysis.Speed,
                    DNA = analysis.DNA,
                    Gegenpress = analysis.Gegenpress,
                    BestInPossessionRole = bestIn?.RoleName ?? "N/A",
                    BestInPossessionScore = bestIn?.Score ?? 0,
                    BestOutPossessionRole = bestOut?.RoleName ?? "N/A",
                    BestOutPossessionScore = bestOut?.Score ?? 0
                });
            }
        }
        else
        {
            rosterItems = new List<RosterItemViewModel>();
        }
    }
}
