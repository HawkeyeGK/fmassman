@page "/"
@rendermode InteractiveServer
@using FM26_Helper.Shared
@using FM26_Helper.Web.Models
@inject RosterRepository Repository
@inject IConfiguration Configuration

<PageTitle>Player Roster</PageTitle>

<h1>Player Roster</h1>

@if (rosterItems == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <div class="grid-scroll-container">
        <QuickGrid Items="@rosterItems.AsQueryable()" Class="table table-striped table-hover table-sm" Pagination="@pagination">
            <TemplateColumn Title="Name" SortBy="@nameSort">
                @context.Name
            </TemplateColumn>
            <PropertyColumn Property="@(p => p.Age)" Sortable="true" />
            <PropertyColumn Property="@(p => p.Wage)" Sortable="true" />
            <PropertyColumn Property="@(p => p.ContractExpiry)" Title="Contract" Sortable="true" />
            
            @* Physical *@
            <PropertyColumn Property="@(p => p.Pace)" Sortable="true" />
            <PropertyColumn Property="@(p => p.Acceleration)" Sortable="true" />
            <PropertyColumn Property="@(p => p.Stamina)" Sortable="true" />
            <PropertyColumn Property="@(p => p.Strength)" Sortable="true" />

            @* Technical *@
            <PropertyColumn Property="@(p => p.Finishing)" Sortable="true" />
            <PropertyColumn Property="@(p => p.Dribbling)" Sortable="true" />
            <PropertyColumn Property="@(p => p.Passing)" Sortable="true" />
            <PropertyColumn Property="@(p => p.Technique)" Sortable="true" />

            @* Mental *@
            <PropertyColumn Property="@(p => p.Composure)" Sortable="true" />
            <PropertyColumn Property="@(p => p.Decisions)" Sortable="true" />
            <PropertyColumn Property="@(p => p.Vision)" Sortable="true" />
            <PropertyColumn Property="@(p => p.WorkRate)" Sortable="true" />
            <PropertyColumn Property="@(p => p.Speed)" Format="F1" Sortable="true" />
            <PropertyColumn Property="@(p => p.DNA)" Format="F1" Sortable="true" />
            <PropertyColumn Property="@(p => p.Gegenpress)" Format="F1" Sortable="true" />
            <PropertyColumn Property="@(p => p.BestInPossessionRole)" Title="Best Role (In)" Sortable="true" />
            <PropertyColumn Property="@(p => p.BestOutPossessionRole)" Title="Best Role (Out)" Sortable="true" />
        </QuickGrid>
    </div>
    <Paginator State="@pagination" />
}


@code {
    private List<RosterItemViewModel>? rosterItems;
    private PaginationState pagination = new PaginationState { ItemsPerPage = 50 };

    // define the custom sort rule
    private static readonly GridSort<RosterItemViewModel> nameSort = 
        GridSort<RosterItemViewModel>.ByAscending(p => p.SortName);

    protected override void OnInitialized()
    {
        var path = Configuration["RosterFilePath"];
        if (!string.IsNullOrEmpty(path))
        {
            var players = Repository.Load(path);
            rosterItems = new List<RosterItemViewModel>();

            foreach (var player in players)
            {
                if (player.Snapshot == null) continue;

                var analysis = PlayerAnalyzer.Analyze(player.Snapshot);
                var bestIn = analysis.InPossessionFits.OrderByDescending(r => r.Score).FirstOrDefault();
                var bestOut = analysis.OutPossessionFits.OrderByDescending(r => r.Score).FirstOrDefault();

                // Logic: Split by last space to find surname. Handle mononyms (single names) gracefully.
                var rawName = player.PlayerName.Trim();
                var lastSpaceIndex = rawName.LastIndexOf(' ');
                var sortName = (lastSpaceIndex > 0)
                    ? $"{rawName.Substring(lastSpaceIndex + 1)}, {rawName.Substring(0, lastSpaceIndex)}"
                    : rawName;

                rosterItems.Add(new RosterItemViewModel
                {
                    Name = player.PlayerName,
                    SortName = sortName,
                    Age = player.Snapshot?.Age ?? 0,
                    Wage = player.Snapshot?.Wage ?? "",
                    ContractExpiry = player.Snapshot?.ContractExpiry ?? "",
                    Speed = analysis.Speed,
                    DNA = analysis.DNA,
                    Gegenpress = analysis.Gegenpress,
                    BestInPossessionRole = bestIn?.RoleName ?? "N/A",
                    BestInPossessionScore = bestIn?.Score ?? 0,
                    BestOutPossessionRole = bestOut?.RoleName ?? "N/A",
                    BestOutPossessionScore = bestOut?.Score ?? 0,

                    // Physical
                    Pace = player.Snapshot?.Physical?.Pace ?? 0,
                    Acceleration = player.Snapshot?.Physical?.Acceleration ?? 0,
                    Stamina = player.Snapshot?.Physical?.Stamina ?? 0,
                    Strength = player.Snapshot?.Physical?.Strength ?? 0,

                    // Technical
                    Finishing = player.Snapshot?.Technical?.Finishing ?? 0,
                    Dribbling = player.Snapshot?.Technical?.Dribbling ?? 0,
                    Passing = player.Snapshot?.Technical?.Passing ?? 0,
                    Technique = player.Snapshot?.Technical?.Technique ?? 0,

                    // Mental
                    Composure = player.Snapshot?.Mental?.Composure ?? 0,
                    Decisions = player.Snapshot?.Mental?.Decisions ?? 0,
                    Vision = player.Snapshot?.Mental?.Vision ?? 0,
                    WorkRate = player.Snapshot?.Mental?.WorkRate ?? 0
                });
            }
        }
        else
        {
            rosterItems = new List<RosterItemViewModel>();
        }
    }
}
