@using fmassman.Shared

<style>
    /* 1. Suppress default Bootstrap focus ring globally for these buttons */
    /* Specificity: (0, 2, 0) */
    .tag-filter-btn:focus {
        box-shadow: none !important;
    }

    /* 2. Define custom permanent glows for SELECTED items */
    /* Includes :focus selector to match specificity of the suppression rule */
    /* Defined AFTER the suppression rule to ensure it wins */
    
    .glow-primary, .glow-primary:focus {
        box-shadow: 0 0 8px rgba(13, 110, 253, 0.6) !important;
    }
    .glow-danger, .glow-danger:focus {
        box-shadow: 0 0 8px rgba(220, 53, 69, 0.6) !important;
    }
    .glow-info, .glow-info:focus {
        box-shadow: 0 0 8px rgba(13, 202, 240, 0.6) !important;
    }
</style>

<div class="d-flex flex-wrap gap-2 mb-3">
    @if (AllTags != null)
    {
        @foreach (var tag in AllTags)
        {
            var isSelected = SelectedTagIds.Contains(tag.Id);
            <button type="button" 
                    class="btn btn-sm rounded-pill tag-filter-btn @GetButtonClass(tag, isSelected)" 
                    @onclick="() => ToggleTag(tag.Id)">
                @tag.Name
                @if (isSelected)
                {
                    <i class="bi bi-check ms-1"></i>
                }
            </button>
        }
    }
</div>

@code {
    [Parameter]
    public List<TagDefinition> AllTags { get; set; } = new();

    [Parameter]
    public List<string> SelectedTagIds { get; set; } = new();

    [Parameter]
    public EventCallback<List<string>> SelectedTagIdsChanged { get; set; }

    [Parameter]
    public EventCallback OnChange { get; set; }

    protected override void OnParametersSet()
    {
        // Debug logging to diagnose tag mismatch issues
        if (AllTags != null && AllTags.Any())
        {
            Console.WriteLine("=== TagFilter Debug Info ===");
            Console.WriteLine($"Total Tags: {AllTags.Count}");
            foreach (var tag in AllTags)
            {
                var isSelected = SelectedTagIds?.Contains(tag.Id) ?? false;
                Console.WriteLine($"Tag: '{tag.Name}' | ID: '{tag.Id}' | Selected: {isSelected} | IsRostered: {tag.IsRostered}");
            }
            Console.WriteLine($"Total Selected IDs: {SelectedTagIds?.Count ?? 0}");
            if (SelectedTagIds != null && SelectedTagIds.Any())
            {
                Console.WriteLine($"Selected Tag IDs: {string.Join(", ", SelectedTagIds.Select(id => $"'{id}'"))}");
            }
            Console.WriteLine("===========================");
        }
    }

    private async Task ToggleTag(string tagId)
    {
        // Create a new list instance to ensure Blazor detects the change
        // Modifying the existing list in-place doesn't trigger change detection
        var newSelection = new List<string>(SelectedTagIds);
        
        if (newSelection.Contains(tagId))
        {
            newSelection.Remove(tagId);
            Console.WriteLine($"Removed tag ID: '{tagId}' from selection");
        }
        else
        {
            newSelection.Add(tagId);
            Console.WriteLine($"Added tag ID: '{tagId}' to selection");
        }

        Console.WriteLine($"New selection count: {newSelection.Count}");

        await SelectedTagIdsChanged.InvokeAsync(newSelection);
        await OnChange.InvokeAsync();
    }

    private string GetButtonClass(TagDefinition tag, bool isSelected)
    {
        // Determine base color type
        var colorType = "primary"; // Default/Rostered
        if (tag.IsArchived) colorType = "danger";
        else if (!tag.IsRostered) colorType = "info";

        if (isSelected)
        {
            // Selected: Solid color, Bold, Custom Glow
            return $"btn-{colorType} fw-bold glow-{colorType} border-{colorType}";
        }
        else
        {
            // Unselected: Outline color
            // Focus ring suppressed via .tag-filter-btn:focus css
            return $"btn-outline-{colorType}";
        }
    }
}
