@page "/in-possession"

@using fmassman.Shared
@using fmassman.Client.Models
@using fmassman.Client.Helpers
@using fmassman.Client.Components.Shared
@inject IRosterRepository Repository
@inject IRoleService RoleService

<PageTitle>In Possession Analysis</PageTitle>

<h1>In Possession Analysis</h1>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">
        <h4>Error Loading Analysis</h4>
        <p>@errorMessage</p>
    </div>
}

@if (matrixItems == null && string.IsNullOrEmpty(errorMessage))
{
    <p><em>Loading...</em></p>
}
else if (matrixItems != null)
{
    <RoleMatrixTable Items="@matrixItems" Columns="@columns" />
}

@code {
    private List<MatrixItem>? matrixItems;
    private List<MatrixColumn> columns = new();
    private string errorMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        try 
        {
            // Load roles first so calculator has data
            try { await RoleService.LoadLocalRolesAsync(); } catch { }
            
            var roster = await Repository.LoadAsync();
            if (roster.Count == 0) 
            {
                // Empty Roster: Build columns from cached roles so the table isn't broken
                columns = RoleFitCalculator.GetRoles("InPossession")
                    .OrderBy(r => ScoutingConstants.GetCategoryRank(r.Category)) 
                    .ThenBy(r => r.Name)
                    .Select(r => new MatrixColumn($"{r.Category} - {r.Name}", r.Name, r.Category))
                    .ToList();
                    
                matrixItems = new List<MatrixItem>();
                return;
            }

            // 1. Analyze all players
            // Filter out goalkeepers as per original logic
            var analyzedPlayers = roster
                .Where(p => p.Snapshot != null && p.Snapshot.Goalkeeping == null)
                .Select(p => new { Name = p.PlayerName, Analysis = PlayerAnalyzer.Analyze(p.Snapshot!) })
                .ToList();

            if (analyzedPlayers.Count == 0) 
            {
                 // Empty Analysis: Build columns from cached roles
                columns = RoleFitCalculator.GetRoles("InPossession")
                    .OrderBy(r => ScoutingConstants.GetCategoryRank(r.Category)) 
                    .ThenBy(r => r.Name)
                    .Select(r => new MatrixColumn($"{r.Category} - {r.Name}", r.Name, r.Category))
                    .ToList();
                    
                matrixItems = new List<MatrixItem>();
                return;
            }

            // 2. Build Columns
            var template = analyzedPlayers.First().Analysis.InPossessionFits;
            columns = template
                .OrderBy(r => ScoutingConstants.GetCategoryRank(r.Category)) 
                .ThenBy(r => r.RoleName)
                .Select(r => new MatrixColumn($"{r.Category} - {r.RoleName}", r.RoleName, r.Category))
                .ToList();

            // 3. Build Rows
            var items = new List<MatrixItem>();
            foreach (var item in analyzedPlayers)
            {
                var scoreMap = item.Analysis.InPossessionFits
                    .ToDictionary(r => $"{r.Category} - {r.RoleName}", r => r.Score);

                items.Add(new MatrixItem
                {
                    Name = item.Name,
                    Scores = scoreMap
                });
            }
            
            // Initial Sort done by component, but we can pre-sort valid items
            matrixItems = items.OrderBy(p => p.Name).ToList();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading analysis: {ex.Message}";
        }
    }
}
