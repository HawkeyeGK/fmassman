@page "/in-possession"

@using fmassman.Shared
@using fmassman.Client.Models
@using fmassman.Client.Helpers
@using fmassman.Client.Components.Shared
@using fmassman.Client.Components.Controls
@using fmassman.Client.Services
@using fmassman.Shared.Models
@inject IRosterRepository Repository
@inject IRoleService RoleService
@inject ITacticService TacticService
@inject ITagRepository TagRepository
@inject IPositionService PositionService


<PageTitle>In Possession Analysis</PageTitle>

<div class="d-flex justify-content-end align-items-center mb-3">
    <div class="col-auto d-flex gap-2">
        <select class="form-select form-select-sm bg-dark text-white border-secondary" @bind="selectedCategory">
            <option value="">-- All Positions --</option>
            @foreach (var cat in _roleCategories)
            {
                <option value="@cat">@cat</option>
            }
        </select>
        <select class="form-select form-select-sm bg-dark text-white border-secondary" @bind="selectedTacticId">
            <option value="">-- All Tactics --</option>
            @foreach (var tactic in tactics)
            {
                <option value="@tactic.Id">@tactic.Name</option>
            }
        </select>
    </div>
</div>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">
        <h4>Error Loading Analysis</h4>
        <p>@errorMessage</p>
    </div>
}

@if (matrixItems == null && string.IsNullOrEmpty(errorMessage))
{
    <p><em>Loading...</em></p>
}
else if (matrixItems != null)
{
    <TagFilter AllTags="_allTags" @bind-SelectedTagIds="_selectedTagIds" OnChange="ApplyFilter" />
    <RoleMatrixTable Items="@_filteredMatrixItems" Columns="@GetFilteredColumns().ToList()" NameClass="@GetNameClass" Positions="@_positions" />
}

@code {
    private List<MatrixItem>? matrixItems;
    private List<MatrixColumn> columns = new();
    private List<Tactic> tactics = new();
    private List<RoleDefinition> allRoles = new();
    private string? selectedTacticId;
    private string? selectedCategory;

    private string errorMessage = string.Empty;
    
    // Tags
    private List<TagDefinition> _allTags = new();
    private List<string> _selectedTagIds = new();
    private List<MatrixItem> _filteredMatrixItems = new();
    private List<string> _roleCategories = new();
    private List<PositionDefinition> _positions = new();

    protected override async Task OnInitializedAsync()
    {
        try 
        {
            // Load roles first so calculator has data
            try 
            { 
                allRoles = await RoleService.LoadLocalRolesAsync(); 
                _roleCategories = allRoles
                    .Select(r => r.Category)
                    .Distinct()
                    .OrderBy(c => ScoutingConstants.GetCategoryRank(c))
                    .ToList();
            } 
            catch { }
            try { tactics = await TacticService.GetAllAsync(); } catch { }
            try { _positions = await PositionService.GetAllAsync(); } catch { }
            
            // Load Tags
            _allTags = await TagRepository.GetAllAsync();
            _allTags = _allTags.OrderBy(t => t.Name).ToList();

            // Set Defaults
            SetDefaultTags();

            var roster = await Repository.LoadAsync();
            if (roster.Count == 0) 
            {
                // Empty Roster: Build columns from cached roles so the table isn't broken
                columns = RoleFitCalculator.GetRoles("InPossession")
                    .OrderBy(r => ScoutingConstants.GetCategoryRank(r.Category)) 
                    .ThenBy(r => r.Name)
                    .Select(r => new MatrixColumn($"{r.Category} - {r.Name}", r.Name, r.Category))
                    .ToList();
                    
                matrixItems = new List<MatrixItem>();
                UpdateFilteredItems();
                return;
            }

            // 1. Analyze all players
            // Filter out goalkeepers as per original logic
            var analyzedPlayers = roster
                .Where(p => p.Snapshot != null && p.Snapshot.Goalkeeping == null)
                .Select(p => new { Name = p.PlayerName, TagIds = p.TagIds, PositionId = p.PositionId, Analysis = new PlayerAnalyzer().Analyze(p.Snapshot!) })
                .ToList();

            if (analyzedPlayers.Count == 0) 
            {
                 // Empty Analysis: Build columns from cached roles
                columns = RoleFitCalculator.GetRoles("InPossession")
                    .OrderBy(r => ScoutingConstants.GetCategoryRank(r.Category)) 
                    .ThenBy(r => r.Name)
                    .Select(r => new MatrixColumn($"{r.Category} - {r.Name}", r.Name, r.Category))
                    .ToList();
                    
                matrixItems = new List<MatrixItem>();
                UpdateFilteredItems();
                return;
            }

            // 2. Build Columns
            var template = analyzedPlayers.First().Analysis.InPossessionFits;
            columns = template
                .OrderBy(r => ScoutingConstants.GetCategoryRank(r.Category)) 
                .ThenBy(r => r.RoleName)
                .Select(r => new MatrixColumn($"{r.Category} - {r.RoleName}", r.RoleName, r.Category))
                .ToList();

            // 3. Build Rows
            var items = new List<MatrixItem>();
            foreach (var item in analyzedPlayers)
            {
                var scoreMap = item.Analysis.InPossessionFits
                    .ToDictionary(r => $"{r.Category} - {r.RoleName}", r => r.Score);

                items.Add(new MatrixItem
                {
                    Name = item.Name,
                    TagIds = item.TagIds != null ? new List<string>(item.TagIds) : new(),
                    PositionId = item.PositionId,
                    Scores = scoreMap
                });
            }
            
            // Initial Sort done by component, but we can pre-sort valid items
            matrixItems = items.OrderBy(p => p.Name).ToList();
            UpdateFilteredItems();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading analysis: {ex.Message}";
        }
    }

    private void SetDefaultTags()
    {
        var defaults = _allTags.Where(t => t.IsDefault).Select(t => t.Id).ToList();
        if (defaults.Any())
        {
            _selectedTagIds = defaults;
        }
        else
        {
            _selectedTagIds = _allTags.Where(t => t.IsRostered).Select(t => t.Id).ToList();
            if (!_selectedTagIds.Any()) 
            {
                _selectedTagIds = _allTags.Select(t => t.Id).ToList();
            }
        }
    }

    private void UpdateFilteredItems()
    {
        if (matrixItems == null)
        {
            _filteredMatrixItems = new();
            return;
        }

        if (_selectedTagIds == null || !_selectedTagIds.Any())
        {
            _filteredMatrixItems = new();
            return;
        }

        _filteredMatrixItems = matrixItems
            .Where(i => i.TagIds.Intersect(_selectedTagIds).Any())
            .ToList();
    }

    private void ApplyFilter()
    {
        // Update the filtered list and force re-render
        UpdateFilteredItems();
        StateHasChanged();
    }

    private IEnumerable<MatrixColumn> GetFilteredColumns()
    {
        var filtered = columns.AsEnumerable();

        // 1. Filter by Tactic
        if (!string.IsNullOrEmpty(selectedTacticId))
        {
            var tactic = tactics.FirstOrDefault(t => t.Id == selectedTacticId);
            if (tactic != null)
            {
                var allowedRoleIds = tactic.InPossessionRoleIds ?? new();
                var allowedRoleNames = allRoles
                    .Where(r => allowedRoleIds.Contains(r.Id))
                    .Select(r => r.Name)
                    .ToHashSet();
                
                filtered = filtered.Where(c => allowedRoleNames.Contains(c.Name));
            }
        }

        // 2. Filter by Position (Category)
        if (!string.IsNullOrEmpty(selectedCategory))
        {
             filtered = filtered.Where(c => string.Equals(c.Category, selectedCategory, StringComparison.OrdinalIgnoreCase));
        }

        return filtered;
    }

    private string GetNameClass(MatrixItem item)
    {
        var playerTags = _allTags.Where(t => item.TagIds.Contains(t.Id)).ToList();
        if (playerTags.Any(t => t.IsArchived)) return "text-danger";
        if (!playerTags.Any(t => t.IsRostered)) return "text-info";
        return "text-white";
    }
}
