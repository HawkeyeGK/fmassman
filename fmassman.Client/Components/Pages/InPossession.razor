@page "/in-possession"

@using fmassman.Shared
@using fmassman.Client.Models
@using fmassman.Client.Helpers
@using fmassman.Client.Components.Shared
@using fmassman.Client.Components.Controls
@using fmassman.Client.Services
@inject IRosterRepository Repository
@inject IRoleService RoleService
@inject ITacticService TacticService
@inject ITagRepository TagRepository

<PageTitle>In Possession Analysis</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="mb-0">In Possession Analysis</h1>
    <div class="col-auto">
        <select class="form-select form-select-sm bg-dark text-white border-secondary" @bind="selectedTacticId">
            <option value="">-- All Roles --</option>
            @foreach (var tactic in tactics)
            {
                <option value="@tactic.Id">@tactic.Name</option>
            }
        </select>
    </div>
</div>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">
        <h4>Error Loading Analysis</h4>
        <p>@errorMessage</p>
    </div>
}

@if (matrixItems == null && string.IsNullOrEmpty(errorMessage))
{
    <p><em>Loading...</em></p>
}
else if (matrixItems != null)
{
    <TagFilter AllTags="_allTags" @bind-SelectedTagIds="_selectedTagIds" OnChange="ApplyFilter" />
    <RoleMatrixTable Items="@FilteredMatrixItems" Columns="@GetFilteredColumns().ToList()" RowClass="@GetRowClass" />
}

@code {
    private List<MatrixItem>? matrixItems;
    private List<MatrixColumn> columns = new();
    private List<Tactic> tactics = new();
    private List<RoleDefinition> allRoles = new();
    private string? selectedTacticId;
    private string errorMessage = string.Empty;
    
    // Tags
    private List<TagDefinition> _allTags = new();
    private List<string> _selectedTagIds = new();

    private List<MatrixItem> FilteredMatrixItems
    {
        get
        {
            if (matrixItems == null) return new();
            if (_selectedTagIds == null || !_selectedTagIds.Any()) return new();

            return matrixItems
                .Where(i => i.TagIds.Intersect(_selectedTagIds).Any())
                .ToList();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        try 
        {
            // Load roles first so calculator has data
            try { allRoles = await RoleService.LoadLocalRolesAsync(); } catch { }
            try { tactics = await TacticService.GetAllAsync(); } catch { }
            
            // Load Tags
            _allTags = await TagRepository.GetAllAsync();
            _allTags = _allTags.OrderBy(t => t.Name).ToList();

            // Set Defaults
            SetDefaultTags();

            var roster = await Repository.LoadAsync();
            if (roster.Count == 0) 
            {
                // Empty Roster: Build columns from cached roles so the table isn't broken
                columns = RoleFitCalculator.GetRoles("InPossession")
                    .OrderBy(r => ScoutingConstants.GetCategoryRank(r.Category)) 
                    .ThenBy(r => r.Name)
                    .Select(r => new MatrixColumn($"{r.Category} - {r.Name}", r.Name, r.Category))
                    .ToList();
                    
                matrixItems = new List<MatrixItem>();
                return;
            }

            // 1. Analyze all players
            // Filter out goalkeepers as per original logic
            var analyzedPlayers = roster
                .Where(p => p.Snapshot != null && p.Snapshot.Goalkeeping == null)
                .Select(p => new { Name = p.PlayerName, TagIds = p.TagIds, Analysis = PlayerAnalyzer.Analyze(p.Snapshot!) })
                .ToList();

            if (analyzedPlayers.Count == 0) 
            {
                 // Empty Analysis: Build columns from cached roles
                columns = RoleFitCalculator.GetRoles("InPossession")
                    .OrderBy(r => ScoutingConstants.GetCategoryRank(r.Category)) 
                    .ThenBy(r => r.Name)
                    .Select(r => new MatrixColumn($"{r.Category} - {r.Name}", r.Name, r.Category))
                    .ToList();
                    
                matrixItems = new List<MatrixItem>();
                return;
            }

            // 2. Build Columns
            var template = analyzedPlayers.First().Analysis.InPossessionFits;
            columns = template
                .OrderBy(r => ScoutingConstants.GetCategoryRank(r.Category)) 
                .ThenBy(r => r.RoleName)
                .Select(r => new MatrixColumn($"{r.Category} - {r.RoleName}", r.RoleName, r.Category))
                .ToList();

            // 3. Build Rows
            var items = new List<MatrixItem>();
            foreach (var item in analyzedPlayers)
            {
                var scoreMap = item.Analysis.InPossessionFits
                    .ToDictionary(r => $"{r.Category} - {r.RoleName}", r => r.Score);

                items.Add(new MatrixItem
                {
                    Name = item.Name,
                    TagIds = item.TagIds != null ? new List<string>(item.TagIds) : new(),
                    Scores = scoreMap
                });
            }
            
            // Initial Sort done by component, but we can pre-sort valid items
            matrixItems = items.OrderBy(p => p.Name).ToList();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading analysis: {ex.Message}";
        }
    }

    private void SetDefaultTags()
    {
        var defaults = _allTags.Where(t => t.IsDefault).Select(t => t.Id).ToList();
        if (defaults.Any())
        {
            _selectedTagIds = defaults;
        }
        else
        {
            _selectedTagIds = _allTags.Where(t => t.IsRostered).Select(t => t.Id).ToList();
            if (!_selectedTagIds.Any()) 
            {
                _selectedTagIds = _allTags.Select(t => t.Id).ToList();
            }
        }
    }

    private void ApplyFilter()
    {
        // Re-render
    }

    private IEnumerable<MatrixColumn> GetFilteredColumns()
    {
        if (string.IsNullOrEmpty(selectedTacticId))
        {
            return columns;
        }

        var tactic = tactics.FirstOrDefault(t => t.Id == selectedTacticId);
        if (tactic == null) return columns;

        var allowedRoleIds = tactic.InPossessionRoleIds ?? new();
        
        // Map IDs to Names
        var allowedRoleNames = allRoles
            .Where(r => allowedRoleIds.Contains(r.Id))
            .Select(r => r.Name)
            .ToHashSet();

        return columns.Where(c => allowedRoleNames.Contains(c.Name));
    }

    private string GetRowClass(MatrixItem item)
    {
        var playerTags = _allTags.Where(t => item.TagIds.Contains(t.Id)).ToList();
        if (playerTags.Any(t => t.IsArchived)) return "table-danger";
        if (!playerTags.Any(t => t.IsRostered)) return "table-info";
        return "";
    }
}
