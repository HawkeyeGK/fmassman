@page "/player/{Name}/edit"
@using fmassman.Client.Models
@using fmassman.Client.Components.Controls
@using fmassman.Shared
@using fmassman.Shared.Models
@using fmassman.Client.Services
@inject PlayerEditorViewModel VM
@inject ITagRepository TagRepository
@inject IPositionService PositionService


@if (VM.IsLoading || VM.Player == null)
{
    <div>Loading...</div>
}
else
{
    <div class="container-fluid">
        <h3>Editing: @VM.Player.PlayerName</h3>
        
        <EditForm Model="VM.Player" OnValidSubmit="VM.SaveAsync" FormName="PlayerEditor">
            <DataAnnotationsValidator />
            
            <div class="d-flex justify-content-end mb-3">
                @if (!string.IsNullOrEmpty(VM.Player.Snapshot?.RawImageBlobUrl))
                {
                    <button type="button" class="btn btn-outline-info me-2" @onclick="ToggleImagePanel">
                        <i class="bi @(_isImagePanelVisible ? "bi-image-alt" : "bi-image")"></i>
                        @(_isImagePanelVisible ? "Hide Source Image" : "View Source Image")
                    </button>
                }
                <button type="submit" class="btn btn-primary">Save Changes</button>
                <a href="/player/@Name" class="btn btn-outline-secondary ms-2">Cancel</a>
            </div>

            <div class="row">
                <div class="@(_isImagePanelVisible ? "col-md-4" : "col-12")">
                    <ul class="nav nav-tabs mb-3">
                        <li class="nav-item">
                            <a class="nav-link @(_activeTab == 0 ? "active" : "")" @onclick="() => _activeTab = 0" style="cursor: pointer">Position & Tags</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link @(_activeTab == 1 ? "active" : "")" @onclick="() => _activeTab = 1" style="cursor: pointer">Profile</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link @(_activeTab == 2 ? "active" : "")" @onclick="() => _activeTab = 2" style="cursor: pointer">Technical</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link @(_activeTab == 3 ? "active" : "")" @onclick="() => _activeTab = 3" style="cursor: pointer">Mental</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link @(_activeTab == 4 ? "active" : "")" @onclick="() => _activeTab = 4" style="cursor: pointer">Physical</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link @(_activeTab == 5 ? "active" : "")" @onclick="() => _activeTab = 5" style="cursor: pointer">Set Pieces</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link @(_activeTab == 6 ? "active" : "")" @onclick="() => _activeTab = 6" style="cursor: pointer">Goalkeeping</a>
                        </li>
                    </ul>

                    <div class="tab-content">
                        @if (_activeTab == 0)
                        {
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card shadow-sm mb-4">
                                        <div class="card-header">
                                            <h6 class="mb-0">Primary Position</h6>
                                        </div>
                                        <div class="card-body">
                                            @if (_availablePositions == null)
                                            {
                                                <div class="text-center"><div class="spinner-border spinner-border-sm" role="status"></div> Loading positions...</div>
                                            }
                                            else
                                            {
                                                <div class="mb-3">
                                                    <label class="form-label">Position</label>
                                                    <InputSelect @bind-Value="VM.Player.PositionId" class="form-select">
                                                        <option value="">Select Position...</option>
                                                        @foreach (var pos in _availablePositions)
                                                        {
                                                            <option value="@pos.Id">@pos.Name (@pos.Code)</option>
                                                        }
                                                    </InputSelect>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="card shadow-sm mb-4">
                                        <div class="card-header">
                                            <h6 class="mb-0">Contract & Status</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <label class="form-label">Playing Time</label>
                                                <InputSelect @bind-Value="VM.Player.Snapshot!.PlayingTime" class="form-select">
                                                    <option value="">Select...</option>
                                                    @foreach (var pt in ScoutingConstants.AllPlayingTimes)
                                                    {
                                                        <option value="@pt">@pt</option>
                                                    }
                                                </InputSelect>
                                            </div>
                                            <div class="mb-3">
                                                 <div class="form-check form-switch">
                                                    <InputCheckbox @bind-Value="VM.Player.Snapshot!.OnLoan" class="form-check-input" id="onLoanSwitch" />
                                                    <label class="form-check-label" for="onLoanSwitch">On Loan</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card shadow-sm">
                                <div class="card-header">
                                    <h6 class="mb-0">Tags</h6>
                                </div>
                                <div class="card-body">
                                    @if (_availableTags == null)
                                    {
                                        <div class="text-center"><div class="spinner-border spinner-border-sm" role="status"></div> Loading tags...</div>
                                    }
                                    else if (!_availableTags.Any())
                                    {
                                        <p class="text-muted">No tags defined. <a href="/tags">Create some tags first.</a></p>
                                    }
                                    else
                                    {
                                        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
                                            @foreach (var tag in _availableTags)
                                            {
                                                <div class="col">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" 
                                                               checked="@IsTagSelected(tag.Id)" 
                                                               @onchange="@(e => ToggleTag(tag.Id, e))" 
                                                               id="tag_@tag.Id" />
                                                        <label class="form-check-label d-flex align-items-center" for="tag_@tag.Id">
                                                            @tag.Name
                                                            @if (tag.IsArchived)
                                                            {
                                                                <span class="badge bg-danger ms-2" style="font-size:0.6rem">Archived</span>
                                                            }
                                                            @if (!tag.IsRostered)
                                                            {
                                                                <span class="badge bg-info ms-2" style="font-size:0.6rem">Scouted</span>
                                                            }
                                                        </label>
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    }
                                </div>
                            </div>
                        }

                        @if (_activeTab == 1)
                        {
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Height (ft)</label>
                                        <InputNumber @bind-Value="VM.Player.HeightFeet" class="form-control" />
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Height (in)</label>
                                        <InputNumber @bind-Value="VM.Player.HeightInches" class="form-control" />
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Age</label>
                                        <InputNumber @bind-Value="VM.Player.Snapshot!.Age" class="form-control" />
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Contract Expiry</label>
                                        <InputText @bind-Value="VM.Player.Snapshot!.ContractExpiry" class="form-control" />
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Contract Expiry</label>
                                        <InputText @bind-Value="VM.Player.Snapshot!.ContractExpiry" class="form-control" />
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">My Wage</label>
                                        <InputText @bind-Value="VM.Player.Snapshot!.Wage" class="form-control" />
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Personality</label>
                                        <InputText @bind-Value="VM.Player.Snapshot!.Personality" class="form-control" />
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Transfer Value Low</label>
                                        <InputNumber @bind-Value="VM.Player.Snapshot!.TransferValueLow" class="form-control" />
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Transfer Value High</label>
                                        <InputNumber @bind-Value="VM.Player.Snapshot!.TransferValueHigh" class="form-control" />
                                    </div>
                                </div>
                            </div>
                        }




                        
                        @if (_activeTab == 2 && VM.Player.Snapshot?.Technical != null)
                        {
                            <div class="row row-cols-2 row-cols-md-4 g-3">
                                @if (IsGoalkeeper)
                                {
                                    <AttributeInput Label="First Touch" @bind-Value="VM.Player.Snapshot.Technical.FirstTouch" />
                                    <AttributeInput Label="Passing" @bind-Value="VM.Player.Snapshot.Technical.Passing" />
                                    <AttributeInput Label="Technique" @bind-Value="VM.Player.Snapshot.Technical.Technique" />
                                }
                                else
                                {
                                    <AttributeInput Label="Crossing" @bind-Value="VM.Player.Snapshot.Technical.Crossing" />
                                    <AttributeInput Label="Dribbling" @bind-Value="VM.Player.Snapshot.Technical.Dribbling" />
                                    <AttributeInput Label="Finishing" @bind-Value="VM.Player.Snapshot.Technical.Finishing" />
                                    <AttributeInput Label="First Touch" @bind-Value="VM.Player.Snapshot.Technical.FirstTouch" />
                                    <AttributeInput Label="Heading" @bind-Value="VM.Player.Snapshot.Technical.Heading" />
                                    <AttributeInput Label="Long Shots" @bind-Value="VM.Player.Snapshot.Technical.LongShots" />
                                    <AttributeInput Label="Marking" @bind-Value="VM.Player.Snapshot.Technical.Marking" />
                                    <AttributeInput Label="Passing" @bind-Value="VM.Player.Snapshot.Technical.Passing" />
                                    <AttributeInput Label="Tackling" @bind-Value="VM.Player.Snapshot.Technical.Tackling" />
                                    <AttributeInput Label="Technique" @bind-Value="VM.Player.Snapshot.Technical.Technique" />
                                }
                            </div>
                        }

                        @if (_activeTab == 3 && VM.Player.Snapshot?.Mental != null)
                        {
                            <div class="row row-cols-2 row-cols-md-4 g-3">
                                <AttributeInput Label="Aggression" @bind-Value="VM.Player.Snapshot.Mental.Aggression" />
                                <AttributeInput Label="Anticipation" @bind-Value="VM.Player.Snapshot.Mental.Anticipation" />
                                <AttributeInput Label="Bravery" @bind-Value="VM.Player.Snapshot.Mental.Bravery" />
                                <AttributeInput Label="Composure" @bind-Value="VM.Player.Snapshot.Mental.Composure" />
                                <AttributeInput Label="Concentration" @bind-Value="VM.Player.Snapshot.Mental.Concentration" />
                                <AttributeInput Label="Decisions" @bind-Value="VM.Player.Snapshot.Mental.Decisions" />
                                <AttributeInput Label="Determination" @bind-Value="VM.Player.Snapshot.Mental.Determination" />
                                <AttributeInput Label="Flair" @bind-Value="VM.Player.Snapshot.Mental.Flair" />
                                <AttributeInput Label="Leadership" @bind-Value="VM.Player.Snapshot.Mental.Leadership" />
                                <AttributeInput Label="Off The Ball" @bind-Value="VM.Player.Snapshot.Mental.OffTheBall" />
                                <AttributeInput Label="Positioning" @bind-Value="VM.Player.Snapshot.Mental.Positioning" />
                                <AttributeInput Label="Teamwork" @bind-Value="VM.Player.Snapshot.Mental.Teamwork" />
                                <AttributeInput Label="Vision" @bind-Value="VM.Player.Snapshot.Mental.Vision" />
                                <AttributeInput Label="Work Rate" @bind-Value="VM.Player.Snapshot.Mental.WorkRate" />
                            </div>
                        }

                        @if (_activeTab == 4 && VM.Player.Snapshot?.Physical != null)
                        {
                            <div class="row row-cols-2 row-cols-md-4 g-3">
                                <AttributeInput Label="Acceleration" @bind-Value="VM.Player.Snapshot.Physical.Acceleration" />
                                <AttributeInput Label="Agility" @bind-Value="VM.Player.Snapshot.Physical.Agility" />
                                <AttributeInput Label="Balance" @bind-Value="VM.Player.Snapshot.Physical.Balance" />
                                <AttributeInput Label="Jumping Reach" @bind-Value="VM.Player.Snapshot.Physical.JumpingReach" />
                                <AttributeInput Label="Natural Fitness" @bind-Value="VM.Player.Snapshot.Physical.NaturalFitness" />
                                <AttributeInput Label="Pace" @bind-Value="VM.Player.Snapshot.Physical.Pace" />
                                <AttributeInput Label="Stamina" @bind-Value="VM.Player.Snapshot.Physical.Stamina" />
                                <AttributeInput Label="Strength" @bind-Value="VM.Player.Snapshot.Physical.Strength" />
                            </div>
                        }

                        @if (_activeTab == 5 && VM.Player.Snapshot?.SetPieces != null)
                        {
                            <div class="row row-cols-2 row-cols-md-4 g-3">
                                @if (IsGoalkeeper)
                                {
                                    <AttributeInput Label="Free Kick Taking" @bind-Value="VM.Player.Snapshot.SetPieces.FreeKickTaking" />
                                    <AttributeInput Label="Penalty Taking" @bind-Value="VM.Player.Snapshot.SetPieces.PenaltyTaking" />
                                }
                                else
                                {
                                    <AttributeInput Label="Corners" @bind-Value="VM.Player.Snapshot.SetPieces.Corners" />
                                    <AttributeInput Label="Free Kick Taking" @bind-Value="VM.Player.Snapshot.SetPieces.FreeKickTaking" />
                                    <AttributeInput Label="Long Throws" @bind-Value="VM.Player.Snapshot.SetPieces.LongThrows" />
                                    <AttributeInput Label="Penalty Taking" @bind-Value="VM.Player.Snapshot.SetPieces.PenaltyTaking" />
                                }
                            </div>
                        }

                        @if (_activeTab == 6)
                        {
                            @if (IsGoalkeeper)
                            {
                                @if (VM.Player.Snapshot?.Goalkeeping == null && VM.Player?.Snapshot != null)
                                {
                                     VM.Player.Snapshot.Goalkeeping = new();
                                }

                                @if (VM.Player?.Snapshot?.Goalkeeping != null)
                                {
                                    <div class="row row-cols-2 row-cols-md-4 g-3">
                                        <AttributeInput Label="Aerial Reach" @bind-Value="VM.Player.Snapshot.Goalkeeping.AerialReach" />
                                        <AttributeInput Label="Command of Area" @bind-Value="VM.Player.Snapshot.Goalkeeping.CommandOfArea" />
                                        <AttributeInput Label="Communication" @bind-Value="VM.Player.Snapshot.Goalkeeping.Communication" />
                                        <AttributeInput Label="Eccentricity" @bind-Value="VM.Player.Snapshot.Goalkeeping.Eccentricity" />
                                        <AttributeInput Label="First Touch" @bind-Value="VM.Player.Snapshot.Goalkeeping.FirstTouch" />
                                        <AttributeInput Label="Handling" @bind-Value="VM.Player.Snapshot.Goalkeeping.Handling" />
                                        <AttributeInput Label="Kicking" @bind-Value="VM.Player.Snapshot.Goalkeeping.Kicking" />
                                        <AttributeInput Label="One On Ones" @bind-Value="VM.Player.Snapshot.Goalkeeping.OneOnOnes" />
                                        <AttributeInput Label="Passing" @bind-Value="VM.Player.Snapshot.Goalkeeping.Passing" />
                                        <AttributeInput Label="Punching" @bind-Value="VM.Player.Snapshot.Goalkeeping.Punching" />
                                        <AttributeInput Label="Reflexes" @bind-Value="VM.Player.Snapshot.Goalkeeping.Reflexes" />
                                        <AttributeInput Label="Rushing Out" @bind-Value="VM.Player.Snapshot.Goalkeeping.RushingOut" />
                                        <AttributeInput Label="Throwing" @bind-Value="VM.Player.Snapshot.Goalkeeping.Throwing" />
                                    </div>
                                }
                            }
                            else
                            {
                                <div class="alert alert-info">
                                    Goalkeeping attributes are only applicable to Goalkeepers.
                                </div>
                            }
                        }
                    </div>
                </div>

                @if (_isImagePanelVisible && (!string.IsNullOrEmpty(VM.Player?.Snapshot?.RawImageBlobUrl) || !string.IsNullOrEmpty(_signedImageUrl)))
                {
                    <div class="col-md-8">
                        <div class="card" style="position: sticky; top: 1rem;">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Source Image</h5>
                                <button type="button" class="btn-close" @onclick="ToggleImagePanel" aria-label="Close"></button>
                            </div>
                            <div class="card-body text-center p-2">
                                @if (string.IsNullOrEmpty(_signedImageUrl))
                                {
                                    <div class="text-muted p-5">Requesting secure access...</div>
                                }
                                else
                                {
                                    <img src="@_signedImageUrl" class="img-fluid rounded" style="max-height: 85vh; object-fit: contain;" alt="Source Image" />
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>
        </EditForm>
    </div>
}

@code {
    [Parameter]
    public string Name { get; set; } = string.Empty;

    private int _activeTab = 0;
    private bool _isImagePanelVisible = false;
    private string? _signedImageUrl;
    private List<TagDefinition>? _availableTags;
    private List<PositionDefinition>? _availablePositions;


    private async Task ToggleImagePanel()
    {
        if (!_isImagePanelVisible)
        {
            // We are about to show it. Do we have a token?
            if (string.IsNullOrEmpty(_signedImageUrl) && VM.Player?.Snapshot != null && !string.IsNullOrEmpty(VM.Player.Snapshot.SourceFilename))
            {
                _signedImageUrl = await VM.GetImageSasAsync(VM.Player.Snapshot.SourceFilename);
            }
        }
        _isImagePanelVisible = !_isImagePanelVisible;
    }

    protected override async Task OnInitializedAsync()
    {
        // Parallel load of player, tags, and positions
        var playerTask = VM.LoadAsync(System.Net.WebUtility.UrlDecode(Name));
        var tagsTask = TagRepository.GetAllAsync();
        var positionsTask = PositionService.GetAllAsync();

        await Task.WhenAll(playerTask, tagsTask, positionsTask);
        _availableTags = tagsTask.Result.OrderBy(t => t.Name).ToList();
        _availablePositions = positionsTask.Result.OrderBy(p => p.Name).ToList();
    }

    private bool IsGoalkeeper
    {
        get
        {
            if (string.IsNullOrEmpty(VM.Player?.PositionId) || _availablePositions == null) return false;
            var pos = _availablePositions.FirstOrDefault(p => p.Id == VM.Player.PositionId);
            return pos?.Code == "GK";
        }
    }

    private bool IsTagSelected(string tagId)
    {
        return VM.Player?.TagIds?.Contains(tagId) ?? false;
    }

    private void ToggleTag(string tagId, ChangeEventArgs e)
    {
        if (VM.Player == null) return;
        if (VM.Player.TagIds == null) VM.Player.TagIds = new List<string>();

        if (e.Value is bool isChecked && isChecked)
        {
            if (!VM.Player.TagIds.Contains(tagId))
                VM.Player.TagIds.Add(tagId);
        }
        else
        {
            if (VM.Player.TagIds.Contains(tagId))
                VM.Player.TagIds.Remove(tagId);
        }
    }


}
