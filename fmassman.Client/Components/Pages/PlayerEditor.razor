@page "/player/{Name}/edit"
@using fmassman.Client.Models
@using fmassman.Client.Components.Controls
@inject PlayerEditorViewModel VM


@if (VM.IsLoading || VM.Player == null)
{
    <div>Loading...</div>
}
else
{
    <div class="container-fluid">
        <h3>Editing: @VM.Player.PlayerName</h3>
        
        <EditForm Model="VM.Player" OnValidSubmit="VM.SaveAsync" FormName="PlayerEditor">
            <DataAnnotationsValidator />
            
            <div class="d-flex justify-content-end mb-3">
                @if (!string.IsNullOrEmpty(VM.Player.Snapshot?.RawImageBlobUrl))
                {
                    <button type="button" class="btn btn-outline-info me-2" @onclick="ToggleImagePanel">
                        <i class="bi @(_isImagePanelVisible ? "bi-image-alt" : "bi-image")"></i>
                        @(_isImagePanelVisible ? "Hide Source Image" : "View Source Image")
                    </button>
                }
                <button type="submit" class="btn btn-primary">Save Changes</button>
                <a href="/player/@Name" class="btn btn-outline-secondary ms-2">Cancel</a>
            </div>

            <div class="row">
                <div class="@(_isImagePanelVisible ? "col-md-4" : "col-12")">
                    <ul class="nav nav-tabs mb-3">
                        <li class="nav-item">
                            <a class="nav-link @(_activeTab == 0 ? "active" : "")" @onclick="() => _activeTab = 0" style="cursor: pointer">Profile</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link @(_activeTab == 1 ? "active" : "")" @onclick="() => _activeTab = 1" style="cursor: pointer">Technical</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link @(_activeTab == 2 ? "active" : "")" @onclick="() => _activeTab = 2" style="cursor: pointer">Mental</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link @(_activeTab == 3 ? "active" : "")" @onclick="() => _activeTab = 3" style="cursor: pointer">Physical</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link @(_activeTab == 4 ? "active" : "")" @onclick="() => _activeTab = 4" style="cursor: pointer">Set Pieces</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link @(_activeTab == 5 ? "active" : "")" @onclick="() => _activeTab = 5" style="cursor: pointer">Goalkeeping</a>
                        </li>
                    </ul>

                    <div class="tab-content">
                        @if (_activeTab == 0)
                        {
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Height (ft)</label>
                                        <InputNumber @bind-Value="VM.Player.HeightFeet" class="form-control" />
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Height (in)</label>
                                        <InputNumber @bind-Value="VM.Player.HeightInches" class="form-control" />
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Age</label>
                                        <InputNumber @bind-Value="VM.Player.Snapshot!.Age" class="form-control" />
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Contract Expiry</label>
                                        <InputText @bind-Value="VM.Player.Snapshot!.ContractExpiry" class="form-control" />
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">My Wage</label>
                                        <InputText @bind-Value="VM.Player.Snapshot!.Wage" class="form-control" />
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Personality</label>
                                        <InputText @bind-Value="VM.Player.Snapshot!.Personality" class="form-control" />
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Transfer Value Low</label>
                                        <InputNumber @bind-Value="VM.Player.Snapshot!.TransferValueLow" class="form-control" />
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Transfer Value High</label>
                                        <InputNumber @bind-Value="VM.Player.Snapshot!.TransferValueHigh" class="form-control" />
                                    </div>
                                </div>
                            </div>
                        }
                        
                        @if (_activeTab == 1 && VM.Player.Snapshot?.Technical != null)
                        {
                            <div class="row row-cols-2 row-cols-md-4 g-3">
                                <AttributeInput Label="Crossing" @bind-Value="VM.Player.Snapshot.Technical.Crossing" />
                                <AttributeInput Label="Dribbling" @bind-Value="VM.Player.Snapshot.Technical.Dribbling" />
                                <AttributeInput Label="Finishing" @bind-Value="VM.Player.Snapshot.Technical.Finishing" />
                                <AttributeInput Label="First Touch" @bind-Value="VM.Player.Snapshot.Technical.FirstTouch" />
                                <AttributeInput Label="Heading" @bind-Value="VM.Player.Snapshot.Technical.Heading" />
                                <AttributeInput Label="Long Shots" @bind-Value="VM.Player.Snapshot.Technical.LongShots" />
                                <AttributeInput Label="Marking" @bind-Value="VM.Player.Snapshot.Technical.Marking" />
                                <AttributeInput Label="Passing" @bind-Value="VM.Player.Snapshot.Technical.Passing" />
                                <AttributeInput Label="Tackling" @bind-Value="VM.Player.Snapshot.Technical.Tackling" />
                                <AttributeInput Label="Technique" @bind-Value="VM.Player.Snapshot.Technical.Technique" />
                            </div>
                        }

                        @if (_activeTab == 2 && VM.Player.Snapshot?.Mental != null)
                        {
                            <div class="row row-cols-2 row-cols-md-4 g-3">
                                <AttributeInput Label="Aggression" @bind-Value="VM.Player.Snapshot.Mental.Aggression" />
                                <AttributeInput Label="Anticipation" @bind-Value="VM.Player.Snapshot.Mental.Anticipation" />
                                <AttributeInput Label="Bravery" @bind-Value="VM.Player.Snapshot.Mental.Bravery" />
                                <AttributeInput Label="Composure" @bind-Value="VM.Player.Snapshot.Mental.Composure" />
                                <AttributeInput Label="Concentration" @bind-Value="VM.Player.Snapshot.Mental.Concentration" />
                                <AttributeInput Label="Decisions" @bind-Value="VM.Player.Snapshot.Mental.Decisions" />
                                <AttributeInput Label="Determination" @bind-Value="VM.Player.Snapshot.Mental.Determination" />
                                <AttributeInput Label="Flair" @bind-Value="VM.Player.Snapshot.Mental.Flair" />
                                <AttributeInput Label="Leadership" @bind-Value="VM.Player.Snapshot.Mental.Leadership" />
                                <AttributeInput Label="Off The Ball" @bind-Value="VM.Player.Snapshot.Mental.OffTheBall" />
                                <AttributeInput Label="Positioning" @bind-Value="VM.Player.Snapshot.Mental.Positioning" />
                                <AttributeInput Label="Teamwork" @bind-Value="VM.Player.Snapshot.Mental.Teamwork" />
                                <AttributeInput Label="Vision" @bind-Value="VM.Player.Snapshot.Mental.Vision" />
                                <AttributeInput Label="Work Rate" @bind-Value="VM.Player.Snapshot.Mental.WorkRate" />
                            </div>
                        }

                        @if (_activeTab == 3 && VM.Player.Snapshot?.Physical != null)
                        {
                            <div class="row row-cols-2 row-cols-md-4 g-3">
                                <AttributeInput Label="Acceleration" @bind-Value="VM.Player.Snapshot.Physical.Acceleration" />
                                <AttributeInput Label="Agility" @bind-Value="VM.Player.Snapshot.Physical.Agility" />
                                <AttributeInput Label="Balance" @bind-Value="VM.Player.Snapshot.Physical.Balance" />
                                <AttributeInput Label="Jumping Reach" @bind-Value="VM.Player.Snapshot.Physical.JumpingReach" />
                                <AttributeInput Label="Natural Fitness" @bind-Value="VM.Player.Snapshot.Physical.NaturalFitness" />
                                <AttributeInput Label="Pace" @bind-Value="VM.Player.Snapshot.Physical.Pace" />
                                <AttributeInput Label="Stamina" @bind-Value="VM.Player.Snapshot.Physical.Stamina" />
                                <AttributeInput Label="Strength" @bind-Value="VM.Player.Snapshot.Physical.Strength" />
                            </div>
                        }

                        @if (_activeTab == 4 && VM.Player.Snapshot?.SetPieces != null)
                        {
                            <div class="row row-cols-2 row-cols-md-4 g-3">
                                <AttributeInput Label="Corners" @bind-Value="VM.Player.Snapshot.SetPieces.Corners" />
                                <AttributeInput Label="Free Kick Taking" @bind-Value="VM.Player.Snapshot.SetPieces.FreeKickTaking" />
                                <AttributeInput Label="Long Throws" @bind-Value="VM.Player.Snapshot.SetPieces.LongThrows" />
                                <AttributeInput Label="Penalty Taking" @bind-Value="VM.Player.Snapshot.SetPieces.PenaltyTaking" />
                            </div>
                        }

                        @if (_activeTab == 5 && VM.Player.Snapshot?.Goalkeeping != null)
                        {
                            <div class="row row-cols-2 row-cols-md-4 g-3">
                                <AttributeInput Label="Aerial Reach" @bind-Value="VM.Player.Snapshot.Goalkeeping.AerialReach" />
                                <AttributeInput Label="Command of Area" @bind-Value="VM.Player.Snapshot.Goalkeeping.CommandOfArea" />
                                <AttributeInput Label="Communication" @bind-Value="VM.Player.Snapshot.Goalkeeping.Communication" />
                                <AttributeInput Label="Eccentricity" @bind-Value="VM.Player.Snapshot.Goalkeeping.Eccentricity" />
                                <AttributeInput Label="First Touch" @bind-Value="VM.Player.Snapshot.Goalkeeping.FirstTouch" />
                                <AttributeInput Label="Handling" @bind-Value="VM.Player.Snapshot.Goalkeeping.Handling" />
                                <AttributeInput Label="Kicking" @bind-Value="VM.Player.Snapshot.Goalkeeping.Kicking" />
                                <AttributeInput Label="One On Ones" @bind-Value="VM.Player.Snapshot.Goalkeeping.OneOnOnes" />
                                <AttributeInput Label="Passing" @bind-Value="VM.Player.Snapshot.Goalkeeping.Passing" />
                                <AttributeInput Label="Punching" @bind-Value="VM.Player.Snapshot.Goalkeeping.Punching" />
                                <AttributeInput Label="Reflexes" @bind-Value="VM.Player.Snapshot.Goalkeeping.Reflexes" />
                                <AttributeInput Label="Rushing Out" @bind-Value="VM.Player.Snapshot.Goalkeeping.RushingOut" />
                                <AttributeInput Label="Throwing" @bind-Value="VM.Player.Snapshot.Goalkeeping.Throwing" />
                            </div>
                        }
                    </div>
                </div>

                @if (_isImagePanelVisible && (!string.IsNullOrEmpty(VM.Player.Snapshot?.RawImageBlobUrl) || !string.IsNullOrEmpty(_signedImageUrl)))
                {
                    <div class="col-md-8">
                        <div class="card" style="position: sticky; top: 1rem;">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Source Image</h5>
                                <button type="button" class="btn-close" @onclick="ToggleImagePanel" aria-label="Close"></button>
                            </div>
                            <div class="card-body text-center p-2">
                                @if (string.IsNullOrEmpty(_signedImageUrl))
                                {
                                    <div class="text-muted p-5">Requesting secure access...</div>
                                }
                                else
                                {
                                    <img src="@_signedImageUrl" class="img-fluid rounded" style="max-height: 85vh; object-fit: contain;" alt="Source Image" />
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>
        </EditForm>
        
        @* DEBUG PANEL - Remove after fixing the issue *@
        <div class="card bg-dark border-warning mt-4">
            <div class="card-header bg-warning text-dark">
                <strong>ðŸ”§ DEBUG PANEL</strong> (Remove after fixing save issue)
            </div>
            <div class="card-body">
                @if (VM.SaveCompleted)
                {
                    <div class="alert alert-success">
                        <strong>Save Completed!</strong> Check the trace log below, then:
                        <a href="/player/@Name" class="btn btn-sm btn-primary ms-2">View Profile</a>
                        <a href="/player/@Name/edit" class="btn btn-sm btn-secondary ms-2">Reload Edit Page</a>
                    </div>
                }
                
                <h6>Current GK Values in Memory:</h6>
                @if (VM.Player?.Snapshot?.Goalkeeping != null)
                {
                    var gk = VM.Player.Snapshot.Goalkeeping;
                    <div class="row row-cols-4 g-2 mb-3">
                        <div class="col"><span class="badge bg-secondary">Handling: @gk.Handling</span></div>
                        <div class="col"><span class="badge bg-secondary">Reflexes: @gk.Reflexes</span></div>
                        <div class="col"><span class="badge bg-secondary">AerialReach: @gk.AerialReach</span></div>
                        <div class="col"><span class="badge bg-secondary">CommandOfArea: @gk.CommandOfArea</span></div>
                        <div class="col"><span class="badge bg-secondary">OneOnOnes: @gk.OneOnOnes</span></div>
                        <div class="col"><span class="badge bg-secondary">Kicking: @gk.Kicking</span></div>
                        <div class="col"><span class="badge bg-secondary">Throwing: @gk.Throwing</span></div>
                        <div class="col"><span class="badge bg-secondary">Communication: @gk.Communication</span></div>
                    </div>
                }
                else
                {
                    <p class="text-danger">Goalkeeping is NULL!</p>
                }
                
                <h6>Trace Log:</h6>
                <pre class="bg-black text-success p-2 rounded" style="max-height: 300px; overflow-y: auto; font-size: 0.8rem;">@string.Join("\n", VM.DebugLog)</pre>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public string Name { get; set; } = string.Empty;

    private int _activeTab = 0;
    private bool _isImagePanelVisible = false;
    private string? _signedImageUrl;

    private async Task ToggleImagePanel()
    {
        if (!_isImagePanelVisible)
        {
            // We are about to show it. Do we have a token?
            if (string.IsNullOrEmpty(_signedImageUrl) && VM.Player?.Snapshot != null && !string.IsNullOrEmpty(VM.Player.Snapshot.SourceFilename))
            {
                _signedImageUrl = await VM.GetImageSasAsync(VM.Player.Snapshot.SourceFilename);
            }
        }
        _isImagePanelVisible = !_isImagePanelVisible;
    }

    protected override async Task OnInitializedAsync()
    {
        // Decode the name to ensure we find the player
        await VM.LoadAsync(System.Net.WebUtility.UrlDecode(Name));
    }
}
