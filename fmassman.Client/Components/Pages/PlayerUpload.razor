@page "/upload"
@inject fmassman.Client.Services.ApiRosterService RosterService
@inject ITagRepository TagRepository
@using System.Net.Http.Headers
@using fmassman.Shared

<PageTitle>Player Upload</PageTitle>

<h3>Player Upload</h3>

<div class="row">
    <div class="col-md-6">
        <div class="mb-3">
             <label class="form-label">Assign to Tag:</label>
             <select class="form-select" @bind="_selectedTagId">
                 @foreach (var tag in _tags)
                 {
                     <option value="@tag.Id">@tag.Name</option>
                 }
             </select>
        </div>

        <div class="mb-3">
            <label for="formFile" class="form-label">Select Player Image/Screenshot (.png, .jpg, .jpeg)</label>
            <InputFile OnChange="@LoadFiles" multiple accept=".png,.jpg,.jpeg" class="form-control" id="formFile" />
        </div>
        
        <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" role="switch" id="gkToggle" @bind="_isGoalkeeper">
            <label class="form-check-label" for="gkToggle">Is Goalkeeper?</label>
        </div>
    </div>
</div>

@if (_uploadQueue.Any())
{
    <div class="mt-4">
        <h5>Upload Queue</h5>
        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle">
                <thead>
                    <tr>
                        <th style="width: 40%">File Name</th>
                        <th style="width: 15%">Size</th>
                        <th style="width: 15%">Status</th>
                        <th style="width: 30%">Actions/Message</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in _uploadQueue)
                    {
                        <tr>
                            <td class="text-truncate" style="max-width: 250px;" title="@item.FileName">
                                @item.FileName
                            </td>
                            <td>
                                @FormatFileSize(item.Size)
                            </td>
                            <td>
                                @switch (item.Status)
                                {
                                    case UploadStatus.Pending:
                                        <span class="badge bg-secondary">Pending</span>
                                        break;
                                    case UploadStatus.Processing:
                                        <div class="d-flex align-items-center text-primary">
                                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                            <span>Processing...</span>
                                        </div>
                                        break;
                                    case UploadStatus.Success:
                                        <span class="badge bg-success"><i class="bi bi-check-circle"></i> Success</span>
                                        break;
                                    case UploadStatus.Error:
                                        <span class="badge bg-danger"><i class="bi bi-exclamation-circle"></i> Error</span>
                                        break;
                                }
                            </td>
                            <td>
                                @if (item.Status == UploadStatus.Success && !string.IsNullOrEmpty(item.ResultPlayerName))
                                {
                                    <a href="/player/@item.ResultPlayerName" target="_blank" class="btn btn-sm btn-outline-primary me-1">
                                        <i class="bi bi-eye"></i> View
                                    </a>
                                }
                                else if (item.Status == UploadStatus.Error)
                                {
                                    <small class="text-danger">@item.Message</small>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
}

@code {
    private List<FileUploadState> _uploadQueue = new();
    private bool _isGoalkeeper = false;
    private long maxFileSize = 1024 * 1024 * 10; // 10MB
    private int maxAllowedFiles = 50;
    
    // Tag Integration
    private List<TagDefinition> _tags = new();
    private string _selectedTagId = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _tags = await TagRepository.GetAllAsync();
            _tags = _tags.OrderBy(t => t.Name).ToList();

            var defaultTag = _tags.FirstOrDefault(t => t.IsDefault);
            if (defaultTag != null)
            {
                _selectedTagId = defaultTag.Id;
            }
            else if (_tags.Any())
            {
                _selectedTagId = _tags.First().Id;
            }
        }
        catch (Exception)
        {
            // Handle error silently or log? Tags are auxiliary, so maybe just don't crash
        }
    }

    private async Task LoadFiles(InputFileChangeEventArgs e)
    {
        _uploadQueue.Clear();

        foreach (var file in e.GetMultipleFiles(maxAllowedFiles))
        {
            _uploadQueue.Add(new FileUploadState { File = file });
        }

        // Process queue
        foreach (var item in _uploadQueue)
        {
            item.Status = UploadStatus.Processing;
            StateHasChanged();

            try
            {
                using var fileContent = new StreamContent(item.File.OpenReadStream(maxFileSize));
                fileContent.Headers.ContentType = new MediaTypeHeaderValue(item.File.ContentType);

                var result = await RosterService.UploadPlayerImage(fileContent, _isGoalkeeper);

                if (result != null)
                {
                    // Assign Tag if selected
                    if (!string.IsNullOrEmpty(_selectedTagId))
                    {
                        if (result.TagIds == null) result.TagIds = new List<string>();
                        
                        // User request: "Action: if (!player.TagIds.Contains(_selectedTagId)) { player.TagIds.Add(_selectedTagId); }"
                        if (!result.TagIds.Contains(_selectedTagId))
                        {
                            result.TagIds.Add(_selectedTagId);
                            // We must save again to persist the tag
                            await RosterService.UpsertAsync(result);
                        }
                    }

                    item.Status = UploadStatus.Success;
                    item.ResultPlayerName = result.PlayerName;
                    item.Message = "Uploaded successfully.";
                }
            }
            catch (Exception ex)
            {
                item.Status = UploadStatus.Error;
                item.Message = ex.Message;
            }

            StateHasChanged();
        }
    }

    private string FormatFileSize(long bytes)
    {
        if (bytes < 1024) return $"{bytes} B";
        if (bytes < 1024 * 1024) return $"{bytes / 1024.0:F1} KB";
        return $"{bytes / (1024.0 * 1024.0):F1} MB";
    }

    public class FileUploadState
    {
        public IBrowserFile File { get; set; } = default!;
        public string FileName => File.Name;
        public long Size => File.Size;
        public UploadStatus Status { get; set; } = UploadStatus.Pending;
        public string? ResultPlayerName { get; set; }
        public string? Message { get; set; }
    }

    public enum UploadStatus
    {
        Pending,
        Processing,
        Success,
        Error
    }
}
