@page "/upload"
@inject fmassman.Client.Services.ApiRosterService RosterService
@inject ITagRepository TagRepository
@inject IPositionService PositionService
@using fmassman.Client.Services
@using fmassman.Shared.Models
@using System.Net.Http.Headers
@using fmassman.Shared

<PageTitle>Player Upload</PageTitle>

<h3>Player Upload</h3>

<div class="row">
    <div class="col-md-6">
        <div class="mb-3">
             <label class="form-label">Assign to Tag:</label>
             <select class="form-select" @bind="_selectedTagId">
                 @foreach (var tag in _tags)
                 {
                     <option value="@tag.Id">@tag.Name</option>
                 }
             </select>
        </div>

        <div class="mb-3">
            <label for="formFile" class="form-label">Select Player Image/Screenshot (.png, .jpg, .jpeg)</label>
            <InputFile OnChange="@LoadFiles" multiple accept=".png,.jpg,.jpeg" class="form-control" id="formFile" />
        </div>
        
        <div class="d-flex gap-2">
            <button class="btn btn-primary" @onclick="() => ProcessUploads(false)" disabled="@(_isProcessing || !_uploadQueue.Any(x => x.Status == UploadStatus.Pending) || _uploadQueue.Any(x => x.Status == UploadStatus.Pending && string.IsNullOrEmpty(x.SelectedPositionId)))">
                <i class="bi bi-cloud-upload"></i> Upload Only
            </button>
            <button class="btn btn-success" @onclick="() => ProcessUploads(true)" disabled="@(_isProcessing || !_uploadQueue.Any(x => x.Status == UploadStatus.Pending) || _uploadQueue.Any(x => x.Status == UploadStatus.Pending && string.IsNullOrEmpty(x.SelectedPositionId)))">
                <i class="bi bi-cloud-bolt"></i> Upload & Push to Miro
            </button>
        </div>
    </div>
</div>

@if (_uploadQueue.Any())
{
    <div class="mt-4">
        <h5>Upload Queue</h5>
        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle">
                <thead>
                    <tr>
                        <th style="width: 30%">File Name</th>
                        <th style="width: 10%">Size</th>
                        <th style="width: 20%">Position</th>
                        <th style="width: 10%">Status</th>
                        <th style="width: 30%">Actions/Message</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in _uploadQueue)
                    {
                        <tr>
                            <td class="text-truncate" style="max-width: 250px;" title="@item.FileName">
                                @item.FileName
                            </td>
                            <td>
                                @FormatFileSize(item.Size)
                            </td>
                            <td>
                                @if (item.Status == UploadStatus.Pending || item.Status == UploadStatus.Error)
                                {
                                    <select class="form-select form-select-sm" @bind="item.SelectedPositionId">
                                        <option value="">Select...</option>
                                        @foreach (var pos in _positions)
                                        {
                                            <option value="@pos.Id">@pos.Name (@pos.Code)</option>
                                        }
                                    </select>
                                }
                                else
                                {
                                    var posName = _positions.FirstOrDefault(p => p.Id == item.SelectedPositionId)?.Name ?? "-";
                                    <small>@posName</small>
                                }
                            </td>
                            <td>
                                @switch (item.Status)
                                {
                                    case UploadStatus.Pending:
                                        <span class="badge bg-secondary">Pending</span>
                                        break;
                                    case UploadStatus.Processing:
                                        <div class="d-flex align-items-center text-primary">
                                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                            <span>Processing...</span>
                                        </div>
                                        break;
                                    case UploadStatus.Success:
                                        <span class="badge bg-success"><i class="bi bi-check-circle"></i> Success</span>
                                        break;
                                    case UploadStatus.Error:
                                        <span class="badge bg-danger"><i class="bi bi-exclamation-circle"></i> Error</span>
                                        break;
                                }
                            </td>
                            <td>
                                @if (item.Status == UploadStatus.Success && !string.IsNullOrEmpty(item.ResultPlayerName))
                                {
                                    <a href="/player/@item.ResultPlayerName" target="_blank" class="btn btn-sm btn-outline-primary me-1">
                                        <i class="bi bi-eye"></i> View
                                    </a>
                                }
                                else if (item.Status == UploadStatus.Error)
                                {
                                    <small class="text-danger">@item.Message</small>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
}

@code {
    private List<FileUploadState> _uploadQueue = new();
    private bool _isProcessing = false;
    private long maxFileSize = 1024 * 1024 * 10; // 10MB
    private int maxAllowedFiles = 50;
    
    // Tag Integration
    private List<TagDefinition> _tags = new();
    private string _selectedTagId = string.Empty;

    // Position Integration
    private List<PositionDefinition> _positions = new();
    
    protected override async Task OnInitializedAsync()
    {
        try
        {
            var tagsTask = TagRepository.GetAllAsync();
            var positionsTask = PositionService.GetAllAsync();

            await Task.WhenAll(tagsTask, positionsTask);

            _tags = (await tagsTask).OrderBy(t => t.DisplayOrder).ThenBy(t => t.Name).ToList();
            _positions = (await positionsTask).OrderBy(p => p.Name).ToList();

            var defaultTag = _tags.FirstOrDefault(t => t.IsDefault);
            if (defaultTag != null)
            {
                _selectedTagId = defaultTag.Id;
            }
            else if (_tags.Any())
            {
                _selectedTagId = _tags.First().Id;
            }
        }
        catch (Exception)
        {
            // Handle error silently or log? Tags/Positions are auxiliary
        }
    }

    private void LoadFiles(InputFileChangeEventArgs e)
    {
        // Don't clear queue, just append new files
        foreach (var file in e.GetMultipleFiles(maxAllowedFiles))
        {
            _uploadQueue.Add(new FileUploadState { File = file });
        }
    }

    private async Task ProcessUploads(bool pushToMiro)
    {
        if (_isProcessing) return;
        _isProcessing = true;

        try
        {
            var pendingItems = _uploadQueue.Where(x => x.Status == UploadStatus.Pending || x.Status == UploadStatus.Error).ToList();

            foreach (var item in pendingItems)
            {
                if (string.IsNullOrEmpty(item.SelectedPositionId)) continue; // Should be guarded by button but safety check

                item.Status = UploadStatus.Processing;
                item.Message = "Uploading...";
                StateHasChanged();

                try
                {
                    using var fileContent = new StreamContent(item.File.OpenReadStream(maxFileSize));
                    fileContent.Headers.ContentType = new MediaTypeHeaderValue(item.File.ContentType);

                    // Determine IsGoalkeeper based on item position
                    var isGoalkeeper = false;
                    var pos = _positions.FirstOrDefault(p => p.Id == item.SelectedPositionId);
                    if (pos != null && pos.Code.Equals("GK", StringComparison.OrdinalIgnoreCase))
                    {
                        isGoalkeeper = true;
                    }
                    
                    var result = await RosterService.UploadPlayerImage(fileContent, isGoalkeeper);

                    if (result != null)
                    {
                        var needsUpdate = false;

                        // Assign Tag if selected
                        if (!string.IsNullOrEmpty(_selectedTagId))
                        {
                            if (result.TagIds == null) result.TagIds = new List<string>();
                            
                            if (!result.TagIds.Contains(_selectedTagId))
                            {
                                result.TagIds.Add(_selectedTagId);
                                needsUpdate = true;
                            }
                        }

                        // Assign Position if selected
                        if (!string.IsNullOrEmpty(item.SelectedPositionId) && result.PositionId != item.SelectedPositionId)
                        {
                                result.PositionId = item.SelectedPositionId;
                                needsUpdate = true;
                        }

                        if (needsUpdate)
                        {
                            await RosterService.UpsertAsync(result);
                        }

                        item.ResultPlayerName = result.PlayerName;
                        
                        // Miro Push Logic
                        if (pushToMiro && !string.IsNullOrEmpty(item.SelectedPositionId))
                        {
                                item.Message = "Uploaded. Pushing to Miro...";
                                StateHasChanged();

                                try 
                                {
                                    var pushed = await RosterService.PushToMiroAsync(result.PlayerName);
                                    if (pushed)
                                    {
                                        item.Status = UploadStatus.Success;
                                        item.Message = "Uploaded & Pushed to Miro successfully.";
                                    }
                                    else 
                                    {
                                        item.Status = UploadStatus.Success; // Upload still worked
                                        item.Message = "Uploaded, but Miro push failed.";
                                    }
                                }
                                catch (Exception exMiro)
                                {
                                    item.Status = UploadStatus.Success; // Upload still worked
                                    item.Message = $"Uploaded, but Miro push error: {exMiro.Message}";
                                }
                        }
                        else
                        {
                            item.Status = UploadStatus.Success;
                            item.Message = pushToMiro ? "Uploaded (Miro push skipped, criteria not met)." : "Uploaded successfully.";
                        }
                    }
                }
                catch (Exception ex)
                {
                    item.Status = UploadStatus.Error;
                    item.Message = ex.Message;
                }

                StateHasChanged();
            }
        }
        finally
        {
            _isProcessing = false;
        }
    }

    private string FormatFileSize(long bytes)
    {
        if (bytes < 1024) return $"{bytes} B";
        if (bytes < 1024 * 1024) return $"{bytes / 1024.0:F1} KB";
        return $"{bytes / (1024.0 * 1024.0):F1} MB";
    }

    public class FileUploadState
    {
        public IBrowserFile File { get; set; } = default!;
        public string FileName => File.Name;
        public long Size => File.Size;
        public UploadStatus Status { get; set; } = UploadStatus.Pending;
        public string? ResultPlayerName { get; set; }
        public string? Message { get; set; }
        public string SelectedPositionId { get; set; } = string.Empty;
    }

    public enum UploadStatus
    {
        Pending,
        Processing,
        Success,
        Error
    }
}
