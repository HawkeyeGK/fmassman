@page "/upload"
@inject fmassman.Client.Services.ApiRosterService RosterService
@using System.Net.Http.Headers
@using fmassman.Shared

<PageTitle>Player Upload</PageTitle>

<h3>Player Upload</h3>

<div class="row">
    <div class="col-md-6">
        <div class="mb-3">
            <label for="formFile" class="form-label">Select Player Image/Screenshot (.png, .jpg, .jpeg)</label>
            <InputFile OnChange="@LoadFiles" accept=".png,.jpg,.jpeg" class="form-control" id="formFile" />
        </div>
        
        <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" role="switch" id="gkToggle" @bind="_isGoalkeeper">
            <label class="form-check-label" for="gkToggle">Is Goalkeeper?</label>
        </div>
    </div>
</div>

@if (isLoading)
{
    <div class="d-flex align-items-center mt-3">
        <div class="spinner-border text-primary me-2" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <span>Processing...</span>
    </div>
}

@if (!string.IsNullOrEmpty(statusMessage) || !string.IsNullOrEmpty(_createdPlayerName))
{
    <div class="alert @(isError ? "alert-danger" : "alert-success") mt-3" role="alert">
        @if (!string.IsNullOrEmpty(_createdPlayerName))
        {
            <div class="mt-2">
                <strong>Success!</strong> Player <em>@_createdPlayerName</em> has been imported.
                <div class="mt-1">
                    <a href="/player/@_createdPlayerName" class="btn btn-sm btn-success me-2">
                        <i class="bi bi-eye"></i> View Profile
                    </a>
                    <a href="/player/@_createdPlayerName/edit" class="btn btn-sm btn-outline-success">
                        <i class="bi bi-pencil"></i> Edit
                    </a>
                </div>
            </div>
        }
        else
        {
            <span>@statusMessage</span>
        }
    </div>
}

@code {
    private bool isLoading = false;
    private string? statusMessage;
    private string? _createdPlayerName;
    private bool isError = false;
    private bool _isGoalkeeper = false;
    private long maxFileSize = 1024 * 1024 * 10; // 10MB

    private async Task LoadFiles(InputFileChangeEventArgs e)
    {
        isLoading = true;
        statusMessage = null;
        _createdPlayerName = null;
        isError = false;

        try
        {
            var file = e.File;
            
            // Basic validation check for extension if needed, though 'accept' attribute helps on client side.
            // Server side will also validate usually.

            using var fileContent = new StreamContent(file.OpenReadStream(maxFileSize));
            fileContent.Headers.ContentType = new MediaTypeHeaderValue(file.ContentType);

            // Pass the stream directly (Raw Binary Upload)
            var result = await RosterService.UploadPlayerImage(fileContent, _isGoalkeeper);
            
            _createdPlayerName = result?.PlayerName;
            statusMessage = "Player image uploaded and processed successfully!";
        }
        catch (Exception ex)
        {
            isError = true;
            statusMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }
}
