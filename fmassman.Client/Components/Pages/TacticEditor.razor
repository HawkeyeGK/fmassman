@page "/tactic/{Id?}"
@using fmassman.Shared
@using fmassman.Shared.Services
@using fmassman.Client.Services
@inject ITacticService TacticService
@inject IRoleService RoleService
@inject NavigationManager nav

<h3>@(IsNew ? "New Tactic" : "Edit Tactic")</h3>

@if (Model == null || allRoles == null)
{
    <p>Loading...</p>
}
else
{
    <div class="mb-3">
        <label for="name" class="form-label">Tactic Name</label>
        <input type="text" class="form-control" id="name" @bind="Model.Name" />
        @if (showValidation && string.IsNullOrWhiteSpace(Model.Name))
        {
            <div class="text-danger">Name is required.</div>
        }
    </div>

    <div class="row">
        <!-- Column 1: Category Navigation -->
        <div class="col-md-3">
            <h4>Categories</h4>
            <div class="list-group">
                @foreach (var cat in Categories)
                {
                    <button type="button" 
                            class="list-group-item list-group-item-action @(selectedCategory == cat ? "active" : "")"
                            @onclick="() => selectedCategory = cat">
                        @cat
                    </button>
                }
            </div>
        </div>

        <!-- Column 2: Role Selection Area -->
        <div class="col-md-5">
            @if (!string.IsNullOrEmpty(selectedCategory))
            {
                <h4 class="mb-3">Roles: @selectedCategory</h4>
                
                <div class="card mb-3">
                    <div class="card-header">In Possession (@selectedCategory)</div>
                    <div class="list-group list-group-flush">
                        @foreach (var role in GetRolesForCategory(selectedCategory, true))
                        {
                            <label class="list-group-item">
                                <input class="form-check-input me-2" type="checkbox" 
                                       checked="@IsRoleSelected(role.Id, true)"
                                       @onchange="@(e => ToggleRole(role.Id, true, e.Value))">
                                @role.Name
                            </label>
                        }
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">Out Possession (@selectedCategory)</div>
                    <div class="list-group list-group-flush">
                        @foreach (var role in GetRolesForCategory(selectedCategory, false))
                        {
                            <label class="list-group-item">
                                <input class="form-check-input me-2" type="checkbox" 
                                       checked="@IsRoleSelected(role.Id, false)"
                                       @onchange="@(e => ToggleRole(role.Id, false, e.Value))">
                                @role.Name
                            </label>
                        }
                    </div>
                </div>
            }
            else
            {
                <div class="alert alert-info">Select a category to view roles.</div>
            }
        </div>

        <!-- Column 3: Tactic Summary (The Basket) -->
        <div class="col-md-4">
            <div class="border rounded p-3 bg-light sticky-top" style="top: 1rem; z-index: 100;">
                <h4>Current Tactic</h4>
                
                <h5 class="mt-3">In Possession</h5>
                <div class="d-flex flex-wrap gap-2 mb-3">
                    @foreach (var roleId in Model.InPossessionRoleIds)
                    {
                        var role = GetRole(roleId);
                        if (role != null)
                        {
                            <span class="badge bg-primary d-flex align-items-center p-2">
                                <span class="me-2">@role.Name</span>
                                <button type="button" class="btn-close btn-close-white" style="font-size: 0.5rem;" aria-label="Remove" @onclick="() => RemoveRole(roleId, true)"></button>
                            </span>
                        }
                    }
                    @if (!Model.InPossessionRoleIds.Any())
                    {
                        <div class="text-muted fst-italic">No roles selected</div>
                    }
                </div>

                <h5 class="mt-3">Out Possession</h5>
                 <div class="d-flex flex-wrap gap-2 mb-3">
                    @foreach (var roleId in Model.OutPossessionRoleIds)
                    {
                        var role = GetRole(roleId);
                        if (role != null)
                        {
                            <span class="badge bg-danger d-flex align-items-center p-2">
                                <span class="me-2">@role.Name</span>
                                <button type="button" class="btn-close btn-close-white" style="font-size: 0.5rem;" aria-label="Remove" @onclick="() => RemoveRole(roleId, false)"></button>
                            </span>
                        }
                    }
                    @if (!Model.OutPossessionRoleIds.Any())
                    {
                        <div class="text-muted fst-italic">No roles selected</div>
                    }
                </div>

                 <div class="mt-4 d-grid gap-2">
                    <button class="btn btn-primary" @onclick="Save">Save Tactic</button>
                    <button class="btn btn-secondary" @onclick="Cancel">Cancel</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public string? Id { get; set; }

    private Tactic? Model { get; set; }
    private bool IsNew => string.IsNullOrEmpty(Id) || Id == "new";
    private bool showValidation = false;

    private List<RoleDefinition>? allRoles;
    private List<string> Categories { get; set; } = new();
    private string? selectedCategory;

    protected override async Task OnInitializedAsync()
    {
        // Load Roles first
        allRoles = await RoleService.LoadLocalRolesAsync();
        
        Categories = allRoles
            .Select(r => r.Category)
            .Distinct()
            .OrderBy(c => ScoutingConstants.GetCategoryRank(c))
            .ToList();
            
        selectedCategory = Categories.FirstOrDefault();

        if (IsNew)
        {
            Model = new Tactic();
        }
        else
        {
            Model = await TacticService.GetByIdAsync(Id!);
            if (Model == null)
            {
                // Handle not found
                nav.NavigateTo("/tactics");
            }
        }
    }

    private IEnumerable<RoleDefinition> GetRolesForCategory(string category, bool inPossession)
    {
        if (allRoles == null) return Enumerable.Empty<RoleDefinition>();
        var phase = inPossession ? "InPossession" : "OutPossession";
        return allRoles.Where(r => r.Category == category && r.Phase == phase).OrderBy(r => r.Name);
    }

    private RoleDefinition? GetRole(string roleId)
    {
        return allRoles?.FirstOrDefault(r => r.Id == roleId);
    }

    private bool IsRoleSelected(string roleId, bool isInPossession)
    {
        if (Model == null) return false;
        var list = isInPossession ? Model.InPossessionRoleIds : Model.OutPossessionRoleIds;
        return list.Contains(roleId);
    }

    private void ToggleRole(string roleId, bool isInPossession, object? checkedValue)
    {
        if (Model == null) return;
        var isChecked = checkedValue is bool b && b;
        var list = isInPossession ? Model.InPossessionRoleIds : Model.OutPossessionRoleIds;

        if (isChecked && !list.Contains(roleId))
        {
            list.Add(roleId);
        }
        else if (!isChecked && list.Contains(roleId))
        {
            list.Remove(roleId);
        }
    }

    private void RemoveRole(string roleId, bool isInPossession)
    {
        if (Model == null) return;
        var list = isInPossession ? Model.InPossessionRoleIds : Model.OutPossessionRoleIds;
        if (list.Contains(roleId))
        {
            list.Remove(roleId);
        }
    }

    private async Task Save()
    {
        showValidation = true;
        if (Model == null || string.IsNullOrWhiteSpace(Model.Name)) return;

        await TacticService.SaveAsync(Model);
        nav.NavigateTo("/tactics");
    }

    private void Cancel()
    {
        nav.NavigateTo("/tactics");
    }
}
