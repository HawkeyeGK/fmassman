@page "/"
@rendermode InteractiveServer
@using fmassman.Shared
@using fmassman.Web.Models
@inject IRosterRepository Repository

<PageTitle>Player Roster</PageTitle>

<h1>Player Roster</h1>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">
        <h4>Error Loading Roster</h4>
        <p>@errorMessage</p>
    </div>
}

@if (rosterItems == null && string.IsNullOrEmpty(errorMessage))
{
    <p><em>Loading...</em></p>
}
else if (rosterItems != null)
{
    <div class="grid-scroll-container">
        <QuickGrid Items="@rosterItems.AsQueryable()" Class="table table-striped table-hover table-sm" Pagination="@pagination">
            <TemplateColumn Title="Name" SortBy="@nameSort">
                <div style="white-space:nowrap; overflow: hidden; text-overflow: ellipsis;" title="@context.Name">
                    <a href="/player/@context.Name" class="text-decoration-none text-info fw-bold">@context.Name</a>
                </div>
            </TemplateColumn>
            <PropertyColumn Property="@(p => p.Age)" Sortable="true" />
            <TemplateColumn Title="Personality" SortBy="@personalitySort">
                <span class="@context.PersonalityCssClass">
                    @context.Personality
                </span>
            </TemplateColumn>
            <TemplateColumn Title="Playing Time" SortBy="@playingTimeSort">
                <span class="@context.PlayingTimeCssClass">
                    @context.PlayingTime
                </span>
            </TemplateColumn>

            <PropertyColumn Property="@(p => p.TransferValueLow)" Title="Min Value" Sortable="true" Format="C0" />
            <PropertyColumn Property="@(p => p.TransferValueHigh)" Title="Max Value" Sortable="true" Format="C0" />
            <PropertyColumn Property="@(p => p.Wage)" Sortable="true" Format="C0" />
            <TemplateColumn Title="Expires" Sortable="true" SortBy="@contractSort">
                <span class="@context.ContractCssClass">
                    @context.ContractExpiry
                </span>
            </TemplateColumn>

            <PropertyColumn Property="@(p => p.Speed)" Title="Spd" Format="F1" Sortable="true" />
            <PropertyColumn Property="@(p => p.DNA)" Title="DNA" Format="F1" Sortable="true" />
            <PropertyColumn Property="@(p => p.Gegenpress)" Title="Press" Format="F1" Sortable="true" />

            <PropertyColumn Property="@(p => p.AggressiveDefense)" Title="Agg Def" Format="F1" Sortable="true" />
            <PropertyColumn Property="@(p => p.CautiousDefense)" Title="Cau Def" Format="F1" Sortable="true" />
            <PropertyColumn Property="@(p => p.DirectAttack)" Title="Dir Att" Format="F1" Sortable="true" />
            <PropertyColumn Property="@(p => p.PossessionAttack)" Title="Pos Att" Format="F1" Sortable="true" />

            <PropertyColumn Property="@(p => p.BestInPossessionRole)" Title="Best Role (In)" Sortable="true" />
            <PropertyColumn Property="@(p => p.BestOutPossessionRole)" Title="Best Role (Out)" Sortable="true" />
        </QuickGrid>
    </div>
    <Paginator State="@pagination" />
}


@code {
    private List<RosterItemViewModel>? rosterItems;
    private PaginationState pagination = new PaginationState { ItemsPerPage = 50 };
    private string errorMessage = string.Empty;

    // define the custom sort rule
    private static readonly GridSort<RosterItemViewModel> nameSort = 
        GridSort<RosterItemViewModel>.ByAscending(p => p.SortName);

    private static readonly GridSort<RosterItemViewModel> personalitySort = 
        GridSort<RosterItemViewModel>.ByAscending(p => ScoutingConstants.GetPersonalityRank(p.Personality));

    private static readonly GridSort<RosterItemViewModel> playingTimeSort = 
        GridSort<RosterItemViewModel>.ByAscending(p => ScoutingConstants.GetPlayingTimeRank(p.PlayingTime));

    // Sort definition referencing the helper
    private static readonly GridSort<RosterItemViewModel> contractSort = 
        GridSort<RosterItemViewModel>.ByAscending(p => RosterItemViewModel.ParseSmartDate(p.ContractExpiry) ?? DateTime.MaxValue);

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var players = await Repository.LoadAsync();
            rosterItems = players.Select(RosterItemViewModel.FromPlayer).ToList();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading roster: {ex.Message}";
        }
    }
}
